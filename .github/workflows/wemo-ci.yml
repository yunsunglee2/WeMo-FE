name: WeMo CI
on:
  push:
    branches:
      - dev
      - "feature/**"

env:
  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
jobs:
  run-test-and-build:
    name: Run Test and Build
    runs-on: ubuntu-latest
    steps:
      - name: Get Codes
        uses: actions/checkout@v4

      - name: Cache node_modules
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/next.config.js', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - if: steps.yarn-cache.outputs.cache-hit == 'true'
        run: echo 'yarn-cache hit!'

      - if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: echo 'yarn-cache missed!'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± í›„ ì£¼ì„ ì‚­ì œ ì˜ˆì •
      # - name: Run Test
      #   run: yarn run test

      - name: Run Build
        run: yarn run build

  create-pr:
    needs: run-test-and-build
    name: Create PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Get Codes
        uses: actions/checkout@v4

      - name: Create PR
        if: startsWith(github.ref, 'refs/heads/feature/') || github.ref == 'refs/heads/dev'
        uses: peter-evans/create-pull-request@v7
        with:
          title: |
            ${{ 
              startsWith(github.ref, 'refs/heads/feature/') && 
              '[feature] feature ë¸Œëœì¹˜ ì‘ì—…ìœ¼ë¡œ ìë™ ìƒì„±ëœ PR (ì œëª©ì„ í¸ì§‘í•´ì£¼ì„¸ìš”!)' || 
              '[dev] dev ë¸Œëœì¹˜ ì‘ì—…ìœ¼ë¡œ ìë™ ìƒì„±ëœ PR (ì œëª©ì„ í¸ì§‘í•´ì£¼ì„¸ìš”!)' 
            }}

          body: |         
            ## ğŸ“ ì‘ì—… ë‚´ìš©
            <!-- ì´ PRì— í¬í•¨ëœ ì‘ì—… ë‚´ìš©ì„ ì„¤ëª…í•˜ì„¸ìš”. ì£¼ìš” ë³€ê²½ ì‚¬í•­, ë²„ê·¸ ìˆ˜ì • ë˜ëŠ” êµ¬í˜„ëœ ê¸°ëŠ¥ì„ í¬í•¨í•´ì£¼ì„¸ìš”. -->
          
            ## ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (ì„ íƒ)
            <!-- ê³µìœ í•˜ê³  ì‹¶ì€ ì‚¬ì§„ì´ ìˆë‹¤ë©´ ì˜¬ë ¤ì£¼ì„¸ìš”! -->
          
            ## âœ… ë¦¬ë·° ìš”êµ¬ì‚¬í•­ (ì„ íƒ)
            - í™•ì¸í•´ì£¼ì„¸ìš”!:
              - [ ] ìš”êµ¬ì‚¬í•­1
              - [ ] ìš”êµ¬ì‚¬í•­2
              - [ ] ìš”êµ¬ì‚¬í•­3
          
            > <!-- ë¦¬ë·°ì–´ê°€ í™•ì¸í–ˆìœ¼ë©´ í•˜ëŠ” ë‚´ìš©ì„ ì¤‘ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. -->


          base: ${{ github.ref == 'dev' && 'main' || 'dev' }}
          branch: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}